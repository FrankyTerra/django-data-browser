(this.webpackJsonpfrontend=this.webpackJsonpfrontend||[]).push([[0],{28:function(e,t,n){},45:function(e,t,n){e.exports=n(60)},50:function(e,t,n){},60:function(e,t,n){"use strict";n.r(t);var a,r,l=n(0),c=n.n(l),o=n(38),i=n.n(o),s=n(63),u=(n(50),n(7)),d=n(14),m=n(15),f=n(25),p=n(26),h=n(8),y=n(5),E=n(13),v=(n(28),n(19)),g=n(30),b=n.n(g),k=document.getElementById("backend-version").textContent.trim();function j(e){var t=e.text,n=Object(l.useRef)(null);return c.a.createElement(c.a.Fragment,null,c.a.createElement("span",{ref:n},t)," ",c.a.createElement(F,{className:"CopyToClipboard",onClick:function(e){var t=document.createRange();t.selectNodeContents(n.current),window.getSelection().removeAllRanges(),window.getSelection().addRange(t),document.execCommand("copy"),window.getSelection().removeAllRanges(),e.target.blur()}},"(copy to clipboard)"))}function F(e){var t=e.className,n=e.onClick,a=e.children;return c.a.createElement("button",Object.assign({onClick:n},{type:"button",className:"Link "+(t||"")}),a)}function O(e){var t=e.className,n=e.onClick,a=e.children;return c.a.createElement("button",Object.assign({onClick:n},{type:"button",className:"sLink material-icons "+(t||"")}),a)}function S(e,t,n){return a&&a.abort(),a=new AbortController,r="".concat(t.method," ").concat(e),fetch(e,Object(u.a)({signal:a.signal},t)).then((function(e){var t=e.headers.get("x-version");return t!==k&&(console.log("Version mismatch, hard reload",k,t),window.location.reload(!0)),e})).then((function(e){return n(e)})).catch((function(e){if("AbortError"!==e.name)throw e;console.log("Request aborted",r)}))}function q(e){return S(e,{method:"GET"},(function(e){return e.json()}))}function w(e){var t=Object(l.useState)(),n=Object(v.a)(t,2),a=n[0],r=n[1];return Object(l.useEffect)((function(){q(e).then((function(e){return r(e)}))}),[e]),[a,function(t){r((function(e){return Object(u.a)({},e,{},t)})),function(e,t){return S(e,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":b.a.get("csrftoken")},body:JSON.stringify(t)},(function(e){return e.json()}))}(e,t).then((function(e){return e&&r((function(t){return Object(u.a)({},t,{},e)}))}))}]}function N(e){var t=e.name,n=e.apiUrl,a=e.data,r=e.redirectUrl,o=Object(l.useState)("save"),i=Object(v.a)(o,2),s=i[0],u=i[1];if("save"===s)return c.a.createElement(F,{onClick:function(e){u("saving"),function(e,t){return S(e,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":b.a.get("csrftoken")},body:JSON.stringify(t)},(function(e){return e.json()}))}(n,a).then((function(e){return u(e)}))}},"Save ",t||"");if("saving"===s)return c.a.createElement(c.a.Fragment,null,"Saving ",t||"");var d="function"===typeof r?r(s):r;return c.a.createElement(y.a,{to:d})}function C(e){var t=e.name,n=e.apiUrl,a=e.redirectUrl,r=Object(l.useState)("normal"),o=Object(v.a)(r,2),i=o[0],s=o[1];if("normal"===i)return c.a.createElement(F,{onClick:function(e){s("confirm")}},"Delete ",t||"");if("confirm"===i)return c.a.createElement(F,{onClick:function(e){var t;s("deleting"),(t=n,S(t,{method:"DELETE",headers:{"X-CSRFToken":b.a.get("csrftoken")}},(function(e){return e}))).then((function(e){return s("deleted")}))}},"Are you sure?");if("deleting"===i)return"Deleting";if("deleted"===i)return c.a.createElement(y.a,{to:a});throw new Error("unknown delete state: ".concat(i))}var M=n(42);function U(e){var t=e.spaces;return t>0?Object(M.a)(Array(t)).map((function(e,t){return c.a.createElement("td",{className:"Empty",key:t})})):null}function V(e){var t=e.query,n=e.field,a=e.className,r=t.getField(n.path),l=t.getType(r);return c.a.createElement("th",{className:a},c.a.createElement(O,{onClick:function(){return t.removeField(n)}},"close"),r.canPivot&&c.a.createElement(c.a.Fragment,null,c.a.createElement(O,{onClick:function(){return t.togglePivot(n)}},n.pivoted?"call_received":"call_made")),r.concrete&&l.defaultLookup?c.a.createElement(c.a.Fragment,null,c.a.createElement(O,{onClick:function(){return t.addFilter(n.path,n.prettyPath)}},"filter_alt")," ",c.a.createElement(F,{onClick:function(){return t.toggleSort(n)}},n.prettyPath.join(" "),{dsc:"\u2191".concat(n.priority),asc:"\u2193".concat(n.priority),null:""}[n.sort])):" "+n.prettyPath.join(" "))}function L(e){var t,n=e.query,a=e.field,r=e.className,l=e.span,o=e.value,i=n.getField(a.path);return t=void 0===o?"":"html"===i.type&&o?c.a.createElement("div",{dangerouslySetInnerHTML:{__html:o}}):String(o),c.a.createElement("td",{className:i.type+" "+r||"",colSpan:l||1},t)}function P(e){var t=e.fields,n=e.query,a=e.classNameFirst;return t.map((function(e,t){return c.a.createElement(V,Object.assign({query:n,field:e},{key:e.pathStr,className:"HoriBorder "+(t?"":a)}))}))}function T(e){var t=e.fields,n=e.query,a=e.classNameFirst,r=e.row;return t.map((function(e,t){return c.a.createElement(L,Object.assign({query:n,field:e},{key:e.pathStr,value:r[e.pathStr],className:t?"":a}))}))}function _(e){var t=e.query,n=e.field,a=e.data,r=e.span;return c.a.createElement(c.a.Fragment,null,c.a.createElement(V,{query:t,field:n}),a.map((function(e,a){return c.a.createElement(L,Object.assign({key:a,query:t,field:n,span:r},{value:e[n.pathStr]}))})))}function x(e){var t=e.query,n=e.cols,a=e.rows,r=e.body;return c.a.createElement("table",{className:"Results"},c.a.createElement("thead",null,t.colFields().map((function(e){return c.a.createElement("tr",{key:e.pathStr},c.a.createElement(U,{spaces:t.rowFields().length-1}),c.a.createElement(_,Object.assign({query:t,field:e},{span:t.resFields().length,data:n})))})),c.a.createElement("tr",null,c.a.createElement(U,{spaces:1-t.rowFields().length}),c.a.createElement(P,Object.assign({query:t},{fields:t.rowFields()})),n.map((function(e,n){return c.a.createElement(P,Object.assign({key:n,query:t},{fields:t.resFields(),classNameFirst:"LeftBorder"}))})))),c.a.createElement("tbody",null,a.map((function(e,n){return c.a.createElement("tr",{key:n},c.a.createElement(U,{spaces:1-t.rowFields().length}),c.a.createElement(T,Object.assign({query:t,row:e},{fields:t.rowFields()})),r.map((function(e,a){return c.a.createElement(T,Object.assign({key:a,query:t},{fields:t.resFields(),row:e[n],classNameFirst:"LeftBorder"}))})))}))))}var D=n(40),R={rows:[{}],cols:[{}],body:[[{}]],filterErrors:[]};function A(e){return{model:e.model,fields:e.fields.map((function(e){return(e.pivoted?"&":"")+e.path.join("__")+{asc:"+".concat(e.priority),dsc:"-".concat(e.priority),null:""}[e.sort]})).join(","),query:e.filters.map((function(e){return"".concat(e.path.join("__"),"__").concat(e.lookup,"=").concat(e.value)})).join("&")}}function Q(e,t,n){var a=A(t),r="".concat(e,"query/").concat(a.model);return"".concat(window.location.origin).concat(r,"/").concat(a.fields,".").concat(n,"?").concat(a.query)}var I=function(){function e(t,n,a){Object(d.a)(this,e),this.config=t,this.query=n,this.setQuery=a}return Object(m.a)(e,[{key:"getField",value:function(e){var t,n=e.slice(-1),a=this.query.model,r=Object(D.a)(e.slice(0,-1));try{for(r.s();!(t=r.n()).done;){var l=t.value;a=this.config.allModelFields[a].fields[l].model}}catch(c){r.e(c)}finally{r.f()}return this.config.allModelFields[a].fields[n]}},{key:"getType",value:function(e){return this.config.types[e.type]}},{key:"getModelFields",value:function(e){return this.config.allModelFields[e]}},{key:"getDefaultLookupValue",value:function(e,t){return String(this.config.types[e.lookups[t].type].defaultValue)}},{key:"addField",value:function(e,t){var n=this.query.fields.slice();n.push({path:e,pathStr:e.join("__"),prettyPath:t,sort:null,priority:null,pivoted:!1}),this.setQuery({fields:n})}},{key:"removeField",value:function(e){this.setQuery({fields:this.query.fields.filter((function(t){return t.pathStr!==e.pathStr}))})}},{key:"toggleSort",value:function(e){var t=this.query.fields.findIndex((function(t){return t.pathStr===e.pathStr})),n={asc:"dsc",dsc:null,null:"asc"}[e.sort],a=this.query.fields.slice();e.sort&&(a=a.map((function(t){return Object(u.a)({},t,{priority:null!=t.priority&&t.priority>e.priority?t.priority-1:t.priority})}))),n?(a=a.map((function(e){return Object(u.a)({},e,{priority:null!=e.priority?e.priority+1:e.priority})})))[t]=Object(u.a)({},e,{sort:n,priority:0}):a[t]=Object(u.a)({},e,{sort:null,priority:null}),this.setQuery({fields:a})}},{key:"togglePivot",value:function(e){var t=this.query.fields.findIndex((function(t){return t.pathStr===e.pathStr})),n=this.query.fields.slice();n[t].pivoted=!n[t].pivoted,this.setQuery({fields:n})}},{key:"addFilter",value:function(e,t){var n=this.getType(this.getField(e)),a=this.query.filters.slice();a.push({path:e,pathStr:e.join("__"),prettyPath:t,lookup:n.defaultLookup,value:this.getDefaultLookupValue(n,n.defaultLookup)}),this.setQuery({filters:a})}},{key:"removeFilter",value:function(e){var t=this.query.filters.slice();t.splice(e,1),this.setQuery({filters:t})}},{key:"setFilterValue",value:function(e,t){var n=this.query.filters.slice();n[e]=Object(u.a)({},n[e],{value:t}),this.setQuery({filters:n})}},{key:"setFilterLookup",value:function(e,t){var n=this.query.filters.slice(),a=n[e],r=this.getType(this.getField(n[e].path));r.lookups[a.lookup].type!==r.lookups[t].type&&(a.value=this.getDefaultLookupValue(r,t)),a.lookup=t,this.setQuery({filters:n})}},{key:"setModel",value:function(e){this.setQuery(Object(u.a)({model:e,fields:[],filters:[]},R))}},{key:"getUrlForMedia",value:function(e){return Q(this.config.baseUrl,this.query,e)}},{key:"colFields",value:function(){return this.query.fields.filter((function(e){return e.pivoted}))}},{key:"rowFields",value:function(){var e=this;return this.colFields().length?this.query.fields.filter((function(t){return!t.pivoted&&e.getField(t.path).canPivot})):this.query.fields}},{key:"resFields",value:function(){var e=this;return this.colFields().length?this.query.fields.filter((function(t){return!e.getField(t.path).canPivot})):[]}}]),e}();function J(e){var t=e.lookup,n=e.onChange,a=e.value;return"boolean"===e.lookup.type?c.a.createElement("select",Object.assign({onChange:n,value:a},{className:"FilterValue"}),c.a.createElement("option",{value:!0},"true"),c.a.createElement("option",{value:!1},"false")):"weekday"===t.type?c.a.createElement("select",Object.assign({onChange:n,value:a},{className:"FilterValue"}),["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].map((function(e){return c.a.createElement("option",{value:e},e)}))):"month"===t.type?c.a.createElement("select",Object.assign({onChange:n,value:a},{className:"FilterValue"}),["January","Febuary","March","April","May","June","July","August","September","October","November","December"].map((function(e){return c.a.createElement("option",{value:e},e)}))):"number"===t.type||"year"===t.type?c.a.createElement("input",Object.assign({onChange:n,value:a},{className:"FilterValue",type:"number",step:"0"})):c.a.createElement("input",Object.assign({onChange:n,value:a},{className:"FilterValue",type:"text"}))}var B=function(e){Object(p.a)(n,e);var t=Object(f.a)(n);function n(){return Object(d.a)(this,n),t.apply(this,arguments)}return Object(m.a)(n,[{key:"render",value:function(){var e=this.props,t=e.path,n=e.prettyPath,a=e.index,r=e.lookup,l=e.query,o=e.value,i=e.errorMessage,s=l.getType(l.getField(t));return c.a.createElement("tr",null,c.a.createElement("td",null,c.a.createElement(O,{onClick:function(){return l.removeFilter(a)}},"close")," ",c.a.createElement(F,{onClick:function(){return l.addField(t,n)}},n.join(" "))," "),c.a.createElement("td",null,c.a.createElement("select",{className:"Lookup",value:r,onChange:function(e){return l.setFilterLookup(a,e.target.value)}},s.sortedLookups.map((function(e){return c.a.createElement("option",{key:e,value:e},e.replace(/_/g," "))})))),c.a.createElement("td",null,"="),c.a.createElement("td",null,c.a.createElement(J,Object.assign({value:o},{onChange:function(e){return l.setFilterValue(a,e.target.value)},lookup:s.lookups[r]})),i&&c.a.createElement("p",null,i)))}}]),n}(c.a.Component);function H(e){var t=e.query,n=e.filterErrors;return c.a.createElement("form",{className:"Filters"},c.a.createElement("table",{className:"Flat"},c.a.createElement("tbody",null,e.filters.map((function(e,a){return c.a.createElement(B,Object.assign({query:t,index:a},e,{key:a,errorMessage:n[a]}))})))))}var X=function(e){Object(p.a)(n,e);var t=Object(f.a)(n);function n(e){var a;return Object(d.a)(this,n),(a=t.call(this,e)).state={toggled:!1},a}return Object(m.a)(n,[{key:"toggle",value:function(){this.setState((function(e){return{toggled:!e.toggled}}))}},{key:"render",value:function(){var e=this.props,t=e.query,n=e.path,a=e.prettyPath,r=e.modelField,l=t.getType(r);return c.a.createElement(c.a.Fragment,null,c.a.createElement("tr",null,c.a.createElement("td",null,r.concrete&&l.defaultLookup&&c.a.createElement(O,{onClick:function(){return t.addFilter(n,a)}},"filter_alt")),c.a.createElement("td",null,r.model&&c.a.createElement(O,{className:"ToggleLink",onClick:this.toggle.bind(this)},this.state.toggled?"remove":"add")),c.a.createElement("td",null,r.type?c.a.createElement(F,{onClick:function(){return t.addField(n,a)}},r.prettyName):r.prettyName)),this.state.toggled&&c.a.createElement("tr",null,c.a.createElement("td",null),c.a.createElement("td",{colSpan:"2"},c.a.createElement(G,Object.assign({query:t,path:n,prettyPath:a},{model:r.model})))))}}]),n}(c.a.Component);function G(e){var t=e.query,n=e.model,a=e.path,r=e.prettyPath,l=t.getModelFields(n);return c.a.createElement("table",null,c.a.createElement("tbody",null,l.sortedFields.map((function(e){var n=l.fields[e];return c.a.createElement(X,Object.assign({key:e},{query:t,modelField:n},{path:a.concat([e]),prettyPath:r.concat([n.prettyName])}))}))))}function W(e){return c.a.createElement("select",{className:"ModelSelector",onChange:function(t){return e.query.setModel(t.target.value)},value:e.model},e.sortedModels.map((function(e){return c.a.createElement("option",{key:e},e)})))}function z(e){return c.a.createElement(E.b,{to:"/",className:"Logo"},c.a.createElement("span",null,"DDB"),c.a.createElement("span",{className:"Version"},"v",k))}function K(e){var t=e.query,n=e.rows,a=e.cols,r=e.body,l=e.sortedModels,o=e.model,i=e.filters,s=e.filterErrors,u=e.baseUrl;return c.a.createElement(c.a.Fragment,null,c.a.createElement(W,{query:t,sortedModels:l,model:o}),c.a.createElement(H,{query:t,filters:i,filterErrors:s}),c.a.createElement("p",null,"Showing ",n.length*a.length," results -"," ",c.a.createElement("a",{href:t.getUrlForMedia("csv")},"Download as CSV")," -"," ",c.a.createElement("a",{href:t.getUrlForMedia("json")},"View as JSON")," -"," ",c.a.createElement(N,{name:"View",apiUrl:"".concat(u,"api/views/"),data:A(t.query),redirectUrl:function(e){return"/views/".concat(e.pk,".html")}})),c.a.createElement("div",{className:"MainSpace"},c.a.createElement("div",{className:"FieldsList"},c.a.createElement(G,Object.assign({query:t,model:o},{path:[],prettyPath:[]}))),t.rowFields().length||t.colFields().length?c.a.createElement(x,{query:t,rows:n,cols:a,body:r}):c.a.createElement("h2",null,"No fields selected")))}function Y(e){var t=e.canMakePublic,n=e.baseUrl,a=Object(y.h)().pk,r="".concat(n,"api/views/").concat(a,"/"),l=w(r),o=Object(v.a)(l,2),i=o[0],s=o[1];return i?c.a.createElement("div",{className:"EditSavedView"},c.a.createElement("div",{className:"SavedViewActions"},c.a.createElement("span",{className:"SavedViewTitle"},"Saved View"),c.a.createElement(E.b,{to:i.link},"Open")),c.a.createElement("form",null,c.a.createElement("input",{type:"text",value:i.name,onChange:function(e){s({name:e.target.value})},className:"SavedViewName",placeholder:"enter a name"}),c.a.createElement("table",null,c.a.createElement("tbody",null,c.a.createElement("tr",null,c.a.createElement("th",null,"Model:"),c.a.createElement("td",null,i.model)),c.a.createElement("tr",null,c.a.createElement("th",null,"Fields:"),c.a.createElement("td",null,i.fields)),c.a.createElement("tr",null,c.a.createElement("th",null,"Filters:"),c.a.createElement("td",null,i.query)))),c.a.createElement("textarea",{value:i.description,onChange:function(e){s({description:e.target.value})},placeholder:"enter a description"}),t&&c.a.createElement("table",null,c.a.createElement("tbody",null,c.a.createElement("tr",null,c.a.createElement("th",null,"Is Public:"),c.a.createElement("td",null,c.a.createElement("input",{type:"checkbox",checked:i.public,onChange:function(e){s({public:e.target.checked})}}))),c.a.createElement("tr",null,c.a.createElement("th",null,"Public link:"),c.a.createElement("td",null,i.public&&c.a.createElement(j,{text:i.public_link}))),c.a.createElement("tr",null,c.a.createElement("th",null,"Google Sheets:"),c.a.createElement("td",null,i.public&&c.a.createElement(j,{text:i.google_sheets_formula})))))),c.a.createElement("div",{className:"SavedViewActions"},c.a.createElement(C,{apiUrl:r,redirectUrl:"/"}),c.a.createElement(E.b,{to:"/"},"Done"))):""}function Z(e){var t=e.baseUrl,n=w("".concat(t,"api/views/")),a=Object(v.a)(n,1)[0];return a?c.a.createElement("div",null,c.a.createElement("h1",null,"Saved Views"),c.a.createElement("div",null,a.map((function(e,t){return c.a.createElement("div",{key:t},c.a.createElement("p",null,c.a.createElement(E.b,{className:"Link",to:e.link},e.model," - ",e.name)," ","(",c.a.createElement(E.b,{to:"/views/".concat(e.pk,".html")},"edit"),")"),c.a.createElement("p",null,e.description))})))):""}function $(e){var t=e.sortedModels,n=e.baseUrl;return c.a.createElement("div",{className:"Index"},c.a.createElement("div",null,c.a.createElement("h1",null,"Models"),c.a.createElement("div",null,t.map((function(e){return c.a.createElement("div",{key:e},c.a.createElement(E.b,{to:"/query/".concat(e,"/.html"),className:"Link"},e))})))),c.a.createElement(Z,{baseUrl:n}))}var ee=n(55);function te(e){"AbortError"===e.name?console.log("request aborted"):(console.log(e),h.a(e))}var ne=function(e){Object(p.a)(n,e);var t=Object(f.a)(n);function n(e){var a;return Object(d.a)(this,n),(a=t.call(this,e)).state=Object(u.a)({booting:!0,model:"",fields:[],filters:[]},R),a}return Object(m.a)(n,[{key:"fetchResults",value:function(e){var t=this;return q(Q(this.props.config.baseUrl,e,"json")).then((function(e){return e&&t.setState({body:e.body,cols:e.cols,rows:e.rows,filterErrors:e.filterErrors}),e}))}},{key:"componentDidMount",value:function(){var e=this,t=this.props,n=t.model,a=t.fieldStr,r=t.queryStr,l=t.config,c="".concat(l.baseUrl,"query/").concat(n,"/").concat(a,".query").concat(r);fetch(c).then((function(e){return e.json()})).then((function(t){var n=Object(u.a)({booting:!1,model:t.model,fields:t.fields,filters:t.filters},R);e.setState(n),window.history.replaceState(n,null,Q(e.props.config.baseUrl,n,"html")),window.onpopstate=function(t){e.setState(t.state),e.fetchResults(t.state).catch(te)},e.fetchResults(e.state).catch(te)}))}},{key:"componentWillUnmount",value:function(){window.onpopstate=function(){}}},{key:"handleQueryChange",value:function(e){this.setState(e);var t=Object(u.a)({},this.state,{},e),n=Object(u.a)({model:t.model,fields:t.fields,filters:t.filters},R);window.history.pushState(n,null,Q(this.props.config.baseUrl,t,"html")),this.fetchResults(t).then((function(e){e=Object(u.a)({},e,{},R),ee.deepStrictEqual(e,n)})).catch(te)}},{key:"render",value:function(){if(this.state.booting)return"";var e=new I(this.props.config,this.state,this.handleQueryChange.bind(this));return c.a.createElement(K,Object.assign({query:e,sortedModels:this.props.config.sortedModels,baseUrl:this.props.config.baseUrl},this.state))}}]),n}(c.a.Component);function ae(e){var t=Object(y.h)(),n=t.model,a=t.fieldStr;return c.a.createElement(ne,Object.assign({},e,{model:n,fieldStr:a||"",queryStr:Object(y.g)().search}))}var re=function(e){var t=e.baseUrl,n=e.sortedModels,a=e.canMakePublic;return c.a.createElement(E.a,{basename:t},c.a.createElement("div",{id:"body"},c.a.createElement(z,null),c.a.createElement(y.d,null,c.a.createElement(y.b,{path:"/query/:model/:fieldStr?.html"},c.a.createElement(ae,Object.assign({config:e},{sortedModels:n}))),c.a.createElement(y.b,{path:"/views/:pk.html"},c.a.createElement(Y,{baseUrl:t,canMakePublic:a})),c.a.createElement(y.b,{path:"/"},c.a.createElement($,{sortedModels:n,baseUrl:t})))))},le=JSON.parse(document.getElementById("backend-config").textContent),ce=document.getElementById("backend-version").textContent.trim();le.sentryDsn&&s.a({dsn:le.sentryDsn,release:ce,attachStacktrace:!0,maxValueLength:1e4}),i.a.render(c.a.createElement(c.a.StrictMode,null,c.a.createElement(re,le)),document.getElementById("root"))}},[[45,1,2]]]);
//# sourceMappingURL=main.db7f152f.chunk.js.map